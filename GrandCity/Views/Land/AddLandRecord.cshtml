@model IEnumerable<MeherEstateDevelopers.Models.Land_Seller_Party>
@{ if (User.IsInRole("Administrator"))
    {
        Layout = "~/Views/Shared/_AdminLayout.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/_StaffLayout.cshtml";
    }
}
<style>
    fieldset.scheduler-border {
        border: 1px groove #ddd !important;
        padding: 0 1.4em 1.4em 1.4em !important;
        margin: 0 0 1.5em 0 !important;
        -webkit-box-shadow: 0px 0px 0px 0px #000;
        box-shadow: 0px 0px 0px 0px #000;
    }

    legend.scheduler-border {
        font-size: 1.2em !important;
        font-weight: bold !important;
        text-align: left !important;
        width: auto;
        padding: 0 10px;
        border-bottom: none;
    }
    .add-form-row {
        padding-top: 4%;
        padding-left: 2%;
    }
    .add-seller-btn {
        float: right;
        margin-top: 2%;
    }
</style>
<div class="col-md-12 bgc-white">
    <hr />
    <h5 class="central-text-align">Add Land Record</h5>
    <hr />

    <div class="row mt-md-3">
        <div class="col-md-1">
            <label>Seller :</label>
        </div>
        <div class="col-md-4">
            <select class="form-control sel-lst"></select>
        </div>
        <div class="col-md-1"></div>
        <div class="col-md-1">
            <label>Deal No :</label>
        </div>
        <div class="col-md-4">
            
            <input type="text" class="form-control del-no" />
        </div>
    </div>
    <div class="row mt-4 add-for-append">

        <div class="col-md-2"></div>
        <div class="col-md-8 add-land-info">
            <fieldset class="scheduler-border">
                <legend class="scheduler-border">Land Info</legend>
                <div class="row mt-md-2">
                    <div class="col-md-4">
                        <label>Moza No.</label>
                        <input type="text" class="form-control moza" />
                    </div>
                    <div class="col-md-4 ">
                        <label>Marraba No.</label>
                        <input type="text" class="form-control mar" />
                    </div>
                    <div class="col-md-4">
                        <label>Khasra No.</label>
                        <input type="text" class="form-control khasra" />
                    </div>
                </div>
                <hr />
                <div class="row">
                    <div class="col-md-3">
                        <h4 style="margin-top:29px">Area Bought</h4>
                    </div>
                    <div class="col-md-3">
                        <label>Kanal</label>
                        <input type="text" class="form-control kanal" />
                    </div>
                    <div class="col-md-3">
                        <label>Marla</label>
                        <input type="text" class="form-control marla" />
                    </div>
                    <div class="col-md-3">
                        <label>SFT.</label>
                        <input type="text" class="form-control squareft" />
                    </div>
                </div>
                <hr />
                <div class="row">
                    <div class="col-md-3">
                        <h6>Khewat</h6>
                        <input type="text" class="form-control khewat" />
                    </div>
                    <div class="col-md-3">
                        <h6>Khatoni</h6>
                        <input type="text" class="form-control khatooni" />
                    </div>
                    <div class="col-md-2 add-form-row">
                        <i class="fas fa-plus-circle">Add</i>
                    </div>
                </div>
            </fieldset>
        </div>
        <div class="col-md-2"></div>
    </div>

    <div class="col-md-12 plts-asgnmnt-area mt-md-3">
    </div>
    <div class="col-md-12">
        <div class="row">
            <div class="col-md-7">
                <h6>Possession status: </h6>
                <input type="text" class="form-control col-md-6 poss" />
            </div>
            <div class="col-md-7">
                <h6>Purchase Price / Acre: </h6>
                <input type="text" class="form-control col-md-6 pur coma pur-price" />
            </div>
            <div class="col-md-7">
                <h6>Payment schedule: </h6>
                <div class="for-append">
                    <div class="row due-amt">
                        <div class="col-3">
                            <input type="text" class="form-control date due-date" placeholder="Due Date" data-provide="datepicker" />
                        </div>
                        <div class="col-3">
                            <input type="text" class="form-control amt coma" placeholder="Amount" />
                        </div>
                        <div class="col-3">
                            <i class="fas fa-plus-circle pointer add-dt-amt" style="margin-left: -12%;padding-top: 7%;">Add</i>
                        </div>
                    </div>
                </div>
                @*<div class="row mt-3">
                    <div class="col-3">
                        <input type="text" class="form-control date" placeholder="Due Date" data-provide="datepicker" />
                    </div>
                    <div class="col-3">
                        <input type="text" class="form-control amt coma" placeholder="Amount" />
                    </div>
                </div>*@
            </div>

            <div class="col-md-7">
                <h6>Any Litigation</h6>
                <textarea class="form-control lit" rows="5" cols="6"></textarea>
            </div>
            <div class="col-md-7">
                <h6>Remarks</h6>
                <textarea class="form-control rem" rows="5" cols="6"></textarea>
            </div>

            <div class="col-md-7">
                <h6>Attachements</h6>
                <input type="file" />
            </div>

        </div>
    </div>
    <hr />
    @*<div class="row mt-md-3" style="justify-content:center;">
            <button class="btn btn-outline-primary add-plt-rw" title="Add another plot for this dealer."><i class="fa fa-plus-circle"></i></button>
        </div>*@
    <hr />

    <div class="row" style="justify-content:flex-end; align-items:center;">
        <div class="col-md-2">
            <button class="btn btn-outline-success save-deal-wth-dtl"><i class="fa fa-save"></i>&nbsp;Save Deal</button>
        </div>
        @*<div class="col-md-2" style="height:75px;">
            <div class="row" style="box-shadow:-3px 10px 8px #888888; justify-content:center;align-items:center; height:60px;">
                <label><b>Total Deal Price:</b></label> &nbsp;<label class="ttl-del-pri"><b>0</b></label>
            </div>
        </div>*@

    </div>

</div>

<script>
    $(document).on('click' , '.add-dt-amt', function () {
        //var html = `<div class="row for-append" style="margin-top: 1%;">
        //                <div class="col-3">
        //                    <input type="text" class="form-control date due-date" placeholder="Due Date" data-provide="datepicker" />
        //                </div>
        //                <div class="col-3">
        //                    <input type="text" class="form-control amt coma" placeholder="Amount" />
        //                </div>
        //                <div class="col-3 aa">
        //                    <i class="fas fa-plus-circle pointer add-dt-amt" style="margin-left: -12%;padding-top: 7%;"></i>
        //                    <i class="fas fa-minus-circle pointer dlt-dt-amt"></i>
        //                </div>
        //        </div>`
        var html = `<div class="row due-amt" style="margin-top: 1%;">
                        <div class="col-3">
                            <input type="text" class="form-control date due-date" placeholder="Due Date" data-provide="datepicker" />
                        </div>
                        <div class="col-3">
                            <input type="text" class="form-control amt coma" placeholder="Amount" />
                        </div>
                        <div class="col-3 aa">
                            <i class="fas fa-plus-circle pointer add-dt-amt" style="margin-left: -12%;padding-top: 7%;"></i>
                            <i class="fas fa-minus-circle pointer dlt-dt-amt"></i>
                        </div>
                    </div>`;
        $('.for-append').append(html);
    });
    $(document).on('click', '.dlt-dt-amt', function () {
        $(this).closest('.aa').closest('.row').remove();
    });
 /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function removeAssignmentRow(element) {
        if (!confirm('Are you sure you want to remove this row?')) {
            return;
        }

        $(element).closest('.plt-asgnmnt-data').fadeOut(function () {
            $(element).closest('.plt-asgnmnt-data').remove();
            UpdateGrandTotalSection();
        });
    }

    function UpdateGrandTotalSection() {
        let ttlAmt = 0;
        $('.plt-asgnmnt-data').each(function (i, v) {
            let dumAmt = parseFloat(RemoveComma($(this).find('.plt-prc-fld').val()));
            let dumSpAmt = parseFloat(RemoveComma($(this).find('.plt-sp-chg-fld').val()));
            let dumDCAmt = parseFloat(RemoveComma($(this).find('.plt-dc-chg-fld').val()));
            let dumDealComAmt = parseFloat(RemoveComma($(this).find('.plt-deal-com-chg-fld').val()));
            let lineTotal = 0;
            dumAmt = isNaN(dumAmt) ? 0 : dumAmt;
            dumSpAmt = isNaN(dumSpAmt) ? 0 : dumSpAmt;
            dumDCAmt = isNaN(dumDCAmt) ? 0 : dumDCAmt;
            dumDealComAmt = isNaN(dumDealComAmt) ? 0 : dumDealComAmt;
            lineTotal = (dumAmt + dumSpAmt + dumDCAmt + dumDealComAmt);
            ttlAmt += lineTotal;

            $(this).find('.ttl-plt-prc-inclsv-all').text(lineTotal.toLocaleString());
        });

        $('.ttl-plts-cnt').text($('.plt-asgnmnt-data').length);
        $('.ttl-prc').text(ttlAmt.toLocaleString());
    }

    $(document).ready(function () {
        $('.sel-lst').select2({
            placeholder: "Search for Land Seller",
            ajax: {
                url: '/Land/GetSellers_ForSelect/',
                dataType: 'json',
                params: {
                    contentType: 'application/json; charset=utf-8'
                },
                data: function (params) {
                    return {
                        q: params.term// search Land Seller
                    };
                },
                processResults: function (data) {
                    return {
                        results: $.map(data.items, function (item) {
                            return {

                                id: item.Id,
                                text: item.text

                            }
                        })
                    };
                }
            }
        });


        $('.add-plt-rw').unbind().click(function () {
            // yahan pe new row append krani hai

            let __strctr__ = `<div class="row plt-asgnmnt-data mt-md-2">
                <div class="col-md-2">
                    <select class="form-control plts-lst">
                    </select>
                </div>

                <div class="col-md-2">
                    <input type="text" class="form-control coma plt-prc-fld" placeholder="Plot Price" value="" />
                </div>

                <div class="col-md-2">
                    <input type="text" class="form-control coma plt-sp-chg-fld" placeholder="Special Charges" value="0" />
                </div>

                <div class="col-md-2">
                    <input type="text" class="form-control coma plt-dc-chg-fld" placeholder="Development Charges" value="0" />
                </div>

                <div class="col-md-2">
                    <input type="text" class="form-control coma plt-deal-com-chg-fld" placeholder="Dealer Commission" value="0" />
                </div>

                <div class="col-md-1">
                    <label><b class="ttl-plt-prc-inclsv-all">0</b></label>
                </div>

                <div class="col-md-1">
                    <button class="btn btn-outline-danger rmv-row-plt-assgnmnt"><i class="fa fa-trash"></i></button>
                </div>
            </div>`;
            $('.plts-asgnmnt-area').append(__strctr__);

            //binding events
            $('.rmv-row-plt-assgnmnt').last().unbind().click(function () {
                removeAssignmentRow($(this));
            });

            $('.plts-lst').last().select2({
                ajax: {
                    url: '/Dealership/GetPlots_ForSelect/',
                    data: function (params) {
                        var query = {
                            s: params.term,
                            type: 'public'
                        }

                        // Query parameters will be ?search=[term]&type=public
                        return query;
                    },
                    processResults: function (data) {
                        // Transforms the top-level key of the response object from 'items' to 'results'
                        return {
                            results: data
                        };
                    }
                }
            });

            $('.plts-lst').last().unbind().change(function () {
                let chosenVal = $(this).val();
                let that = $(this);
                $('.plts-lst').not(this).each(function (i, v) {
                    if ($(this).val() == chosenVal) {
                        alert('Cannot assign same plot multiple times. This plot is already selected');
                        $(that).val(null).trigger('change');
                        return;
                    }
                });
            });



            $('.plt-prc-fld').last().unbind().change(function () {
                UpdateGrandTotalSection();
            });

            $('.plt-sp-chg-fld').last().unbind().change(function () {
                UpdateGrandTotalSection();
            });

            $('.plt-dc-chg-fld').last().unbind().change(function () {
                UpdateGrandTotalSection();
            });

            $('.plt-deal-com-chg-fld').last().unbind().change(function () {
                UpdateGrandTotalSection();
            });

            UpdateGrandTotalSection();
        });

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    });
</script>