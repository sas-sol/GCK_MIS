@model MeherEstateDevelopers.Models.CommercialDetailData
<link href="~/Content/albery.css" rel="stylesheet" />
<script>
     var cities = @Html.Raw(Json.Encode(ViewBag.Cities));
</script>
@{
    string[] Type = { "Advance", "Booking", "Installment", "Full_Paid_Commercial" };
}

@if (Model.shopOwnersMultiple.Any())
{
    <input type="hidden" class="form-control" id="module" value="CommercialManagement">
    <input type="hidden" id="com_rom_tag" value="@Model.commercialData.Id" />
    <div class="bgc-white p-20 bd">
        <div class="form-row row">
            <div class="col-md-12">
                <div class="form-row">
                    <h6 class="c-grey-900">Unit information</h6>
                    <hr class="col-md-12" />
                    <div class="form-group col-md-1">
                        <label>@Model.commercialData.Type No.</label>
                        @if (Model.commercialData.Project_Name == "SA Premium Homes")
                        {
                            <h5 id="shp-no">@Model.commercialData.ApplicationNo</h5>
                        }
                        else
                        {
                            <h5 id="shp-no">@Model.commercialData.shop_no</h5>
                        }

                        <input type="hidden" class="form-control" id="shp-id" value="@Model.commercialData.Id" name="shop_Id" readonly>
                    </div>
                    <div class="form-group col-md-2">
                        <label>Size</label>
                        <h5 id="shp-size">@Model.commercialData.Total_SqFt_Marlas Sq Ft</h5>
                        <input type="hidden" class="form-control" value="@Model.commercialData.Total_SqFt_Marlas" id="sp-size" name="Shop_Size" readonly>
                    </div>
                    <div class="form-group col-md-2">
                        <label>Dimension</label>
                        <h5 id="shop-dim">@Model.commercialData.Dimension</h5>
                    </div>
                    <div class="form-group col-md-2">
                        <label>Project</label>
                        <h5 id="shop-type">@Model.commercialData.Project_Name</h5>
                    </div>
                    <div class="form-group col-md-2">
                        <label>Location</label>
                        <h5 id="shp-loc">@Model.commercialData.Location</h5>
                    </div>
                    @{
                        string stas = "";
                        if (Model.commercialData.Status == "Registered")
                        {

                            stas = "alert alert-success";
                        }
                        else
                        {
                            stas = "alert alert-info";
                        }
                    }
                    <div class="form-group col-md-2">
                        <label>Status</label>
                        <div class="@stas" role="alert"><label>@Model.commercialData.Status.Replace("_", " ")</label></div>
                        <input type="hidden" value="@Model.commercialData.Status" id="shp-stat" />
                    </div>
                    <div class="form-group col-md-2">
                        <input type="button" class="btn btn-info up-dim-c" data-toggle="modal" data-target="#Modal" value="Update Dimension" />
                    </div>
                    @if (User.IsInRole("Change Plot Status"))
                    {
                        <div class="form-group col-md-2">
                            <input type="button" class="btn btn-primary up-stat-c" data-toggle="modal" data-target="#Modal" value="Update @Model.commercialData.Type Status" />
                        </div>
                    }
                    @if (User.IsInRole("Request Commercial Discount") || User.IsInRole("Administrator"))
                    {
                        <div class="form-group col-md-2">
                            <div class="" style="text-align:center">
                                <button class="btn btn-danger com_desc" data-toggle="modal" data-target="#Modal" data-plot="@Model.commercialData.Id">Add Discount</button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
        <hr />
        <div class="row" >
            @{
                int ownercount = 1;
                foreach (var grps in Model.shopOwnersMultiple.OrderByDescending(x => x.DateTime).GroupBy(x => x.GroupTag))
                {
                    <div class=" panel panel-default " id="@ownercount">
                        @foreach (var item in grps)
                        {
                            <input type="hidden" id="" class="filetransid" value="@item.Id" />
                            <input type="hidden" id="" class="groupId" value="@item.GroupTag" />
                            <div id="grp-@item.GroupTag" >
                                <div class="panel-body">
                                    <div class="own-det row up-info col-md-12" id="@item.Id">
                                        <input type="hidden" id="" class="File-trans-id" value="@item.Id" />
                                        <div class="form-row">
                                            <input type="hidden" id="countertrans" />
                                            <div class="form-group col-md-4">
                                                <label>Ownership Status</label>
                                                <select class="form-control" id="Ownership_Status">
                                                    @if (item.Ownership_Status == "Owner")
                                                    {
                                                        <option value="Owner" selected>Owner</option>
                                                        <option value="Transferred">Transferred</option>
                                                        <option value="Cancelled">Cancelled</option>
                                                    }
                                                    else if (item.Ownership_Status == "Transferred")
                                                    {
                                                        <option value="Owner">Owner</option>
                                                        <option value="Transferred" selected>Transferred</option>
                                                        <option value="Cancelled">Cancelled</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="Owner">Owner</option>
                                                        <option value="Transferred" >Transferred</option>
                                                        <option value="Cancelled" selected>Cancelled</option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label>Name</label>
                                                <input type="text" class="form-control" id="Name" value="@item.Name" readonly>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label>Father's/Husband's Name</label>
                                                <input type="text" class="form-control" id="Father_Husband" value="@item.Father_Husband" readonly>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label>CNIC / NICOP</label>
                                                <input type="text" class="form-control" id="CNIC_NICOP" value="@item.CNIC_NICOP" placeholder="12345-1234567-1   or   123456-123456-1" readonly>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label>Date Of Birth</label>
                                                <input type="text" class="form-control" id="Date_Of_Birth" value="@item.Date_Of_Birth" readonly>
                                            </div>
                                            <div class="form-group col-md-7">
                                                <label>Postal Address</label>
                                                <input type="text" class="form-control" id="Postal_Address" value="@item.Postal_Address" placeholder="1234 Main St" readonly>
                                            </div>
                                            <div class="form-group col-md-7">
                                                <label>Residential Address</label>
                                                <input type="text" class="form-control" id="Residential_Address" value="@item.Residential_Address" placeholder="Apartment, Plot, or floor" readonly>
                                            </div>
                                            <div class="form-group col-md-3">
                                                <label>City</label>
                                                <input type="text" class="form-control" id="City" value="@item.City" readonly>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label>Occupation</label>
                                                <input type="text" class="form-control" value="@item.Occupation" id="Occupation" readonly>
                                            </div>
                                            <div class="form-group col-md-3">
                                                <label>Nationality</label>
                                                <input type="text" class="form-control" value="@item.Nationality" id="Nationality" readonly>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label>Email</label>
                                                <input type="text" class="form-control" value="@item.Email" id="Email" readonly>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label>Phone Office</label>
                                                <input type="text" class="form-control" value="@item.Phone_Office" id="Phone_Office" readonly>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label>Residential</label>
                                                <input type="text" class="form-control" value="@item.Residential" id="Residential" readonly>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label>Mobile 1</label>
                                                <input type="text" class="form-control" value="@item.Mobile_1" placeholder="03121234567" id="Mobile_1" readonly>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label>Mobile 2</label>
                                                <input type="text" class="form-control" value="@item.Mobile_1" pattern="^0\d{10}" placeholder="03121234567" id="Mobile_2" readonly>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label>Ownership Date</label>
                                                <input type="text" class="form-control" data-provide="datepicker" value="@item.DateTime.Value.ToShortDateString()" placeholder="Ownership Date" id="Ownership_DateTime" readonly>
                                            </div>
                                            <h6 class="heading-lgt-onDark" style="width:100%">Nominee</h6>
                                            <div class="form-row">
                                                <div class="form-group col-md-4">
                                                    <label>Name</label>
                                                    <input type="text" class="form-control" value="@item.Nominee_Name" id="Nominee_Name" readonly>
                                                </div>
                                                <div class="form-group col-md-4">
                                                    <label>CNIC / NICOP</label>
                                                    <input type="text" class="form-control" value="@item.Nominee_CNIC_NICOP" placeholder="12345-1234567-1 or 123456-123456-1" id="Nominee_CNIC_NICOP" readonly>
                                                </div>
                                                <div class="form-group col-md-3">
                                                    <label>Relation</label>
                                                    <input type="text" class="form-control" value="@item.Nominee_Relation" id="Nominee_Relation" placeholder="" readonly>
                                                </div>
                                                <div class="form-group col-md-6">
                                                    <label>Address</label>
                                                    <input type="text" class="form-control" value="@item.Nominee_Address" id="Nominee_Address" placeholder="1234 Main St" readonly>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-row col-md-12">
                                            <div class="col-md-3">

                                                <div style="width:220px; height:220px;" class="hvr-opt-disp">
                                                    <img style="margin-top:10px;height:100%;width:100%;" src="@item.Owner_Image1" id="own_img" class="owner-img1" data-hint="1" data-owner="@item.Id" />
                                                    <span style="position:absolute;background-color:rgba(0,0,0,0.6);width: 63%;height: 100%; top :10px;display: flex;justify-content: center;align-items: center;display:none;">
                                                        <i class="fa fa-4x fa-upload pointer lime-green-hov own-img-upld-fdjsgha" title="Upload New Image"></i>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-info com-upd-info">Update Information</button>
                                        <button class="btn btn-success sav-info-com" style="display:none" data-ownid="@item.Id" id="sav-btn-@item.Id">Save</button>
                                    </div>
                                </div>
                            </div>
                            ownercount++;
                        }
                    </div>
                }
            }
        </div>
        <div class="Tran-own"></div>
        <hr />
        <div class="form-row">
            <button type="button" class="btn btn-primary fi-reg-ath" style="float:right">Multiple Transfer</button>
        </div>
        <div class="mT-30">
            <div class="col-md-12 " id="ad-reg-form">
            </div>
            <button type="button" class="btn btn-primary" id="re-up-oth-com-own">Add Transfer Owners</button>
        </div>
        <hr />
        <div class="form-row" id="inst-plan" style="display:none">
            <div class="form-group col-md-1">
                <label>Total Price</label>
                <input class="form-control coma gran-cal" value="" id="plt-price" placeholder="300,000" required>
                <input type="hidden" id="plt-pric" class="amt" required>
            </div>
            <div class="form-group col-md-1">
                <label>Disc Amount</label>
                <input class="form-control coma gran-cal" placeholder="300,000">
                <input type="hidden" id="dis-amt" class="amt">
            </div>
            <div class="form-group col-md-2">
                <label>Grand Total</label>
                <input class="form-control" id="grnd-total" readonly>
            </div>
            <div class="form-group col-md-2">
                <label>No. of Insts</label>
                <input type="text" class="form-control" id="ttl-ins">
            </div>
            <div class="form-group col-md-1">
                <label>Advance</label>
                <input class="form-control coma" placeholder="550,000" required>
                <input type="hidden" id="adv-amt" class="amt" required>
            </div>
            <div class="form-group col-md-2">
                <label>Date of Registeration</label>
                <input type="text" class="form-control" placeholder="mm/dd/yyyy" id="reg-date" data-provide="datepicker">
            </div>
            <div class="form-group col-md-2">
                <label>Installment Start Date</label>
                <input type="text" class="form-control" placeholder="mm/dd/yyyy" id="inst-date" data-provide="datepicker">
            </div>
            <div class="form-group col-md-1">
                <label style="width:100%"></label>
                <button type="button" class="btn btn-info" id="gen-ins">Generate</button>
            </div>
            <div class="form-group col-md-1">
                <label style="width:100%"></label>
                <button type="button" class="btn btn-success" id="sav-com-ins">Save</button>
            </div>
        </div>
        <div class="form-row">
            <div class="col-md-5">
                <table class="table table-striped table-bordered" cellspacing="0" width="100%" style="margin-bottom:0px">

                    <thead class="thead-dark">
                        <tr>
                            @if (Model.CommercialReceipts.Where(x => x.Type == "Full_Paid_Commercial").Any())
                            {
                                <h6 class="c-grey-900">Cannot Update Installment</h6>
                            }
                            else if (Model.CommercialInstallments.Where(x => x.Status == "Received").Any())
                            {
                                <h6 class="c-grey-900">Cannot Update Installment</h6>
                            }
                            else
                            {
                                <th><button class="btn btn-primary" id="cr-ins-plan">Update Installment Plan</button></th>
                            }
                            @if (Model.commercialData.Status == "Registered")
                            {
                                <th><button class="btn btn-secondary" id="on-btn-man" name="rece-btn-man" data-toggle="modal" data-target="#Modal">Online Receipts</button></th>
                                <th><input type="button" class="btn btn-info com-inst-btn" data-toggle="modal" data-target="#Modal" value="Manual Installments" /></th>
                            }
                        </tr>
                        <tr>
                            <th>Sr</th>
                            <th>Amount</th>
                            <th>Due Date</th>
                        </tr>
                    </thead>
                </table>
                <div style="min-height:0px; max-height:500px;overflow:auto" class=" ps--active-y">
                    <table class="table table-striped table-bordered" id="all-instments" cellspacing="0" width="100%">
                        <tbody>
                            @{

                                if (!Model.CommercialInstallments.Any())
                                {
                                    <tr>
                                        <td colspan="5">No Record Found</td>
                                    </tr>
                                }
                                else
                                {
                                    int pltinser = 1;
                                    foreach (var item in Model.CommercialInstallments)
                                    {
                                        string statuscolor = "";
                                        if (item.Status == "Paid")
                                        {
                                            statuscolor = "bgc-green-50 pointer";

                                        }
                                        else if (item.Status == "NotPaid")
                                        {
                                            statuscolor = "bgc-red-50 pointer";

                                        }
                                        <tr class="@statuscolor">
                                            <td>@pltinser</td>
                                            <td>@item.Installment_Name</td>
                                            <td>@string.Format("{0:n}", item.Amount)</td>
                                            <td>@string.Format("{0:MM-dd-yyyy}", item.Due_Date)</td>
                                            <td>
                                                @item.Status
                                            </td>
                                        </tr>
                                        pltinser++;
                                    }
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <input type="hidden" id="plt-id" value="@Model.commercialData.Id" />
            <div class="col-md-7">
                @foreach (var g in Model.CommercialReceipts.Where(x => Type.Contains(x.Type)).GroupBy(x => x.Type))
                {
                    <table class="table table-striped table-bordered" id="rec-amts" cellspacing="0" width="100%" style="margin-bottom:0px">
                        <thead class="thead-dark">
                            <tr>
                                <th colspan="8">@g.Key</th>
                            </tr>
                            <tr>
                                <th>Sr.</th>
                                <th>Receipt No.</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Ch/Bd No.</th>
                                <th>Verified</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int srcountd = 1;
                                foreach (var item in g)
                                {
                                    string stat = "";
                                    if (item.Status == "Pending")
                                    {
                                        stat = "bgc-yellow-50";
                                    }
                                    else if (item.Status == "Dishonored")
                                    {
                                        stat = "bgc-red-50";
                                    }
                                    else if (item.Status == "Approved")
                                    {
                                        stat = "bgc-green-50";
                                    }
                                    else if (item.Status == "Deposited")
                                    {
                                        stat = "bgc-orange-50";
                                    }
                                    else
                                    {
                                        stat = "";
                                    }
                                    <tr class="@stat" id="@item.Id">
                                        <td>@srcountd</td>
                                        <td class="rece-num">@item.ReceiptNo</td>
                                        <td class="rece-amt">@string.Format("{0:n}", item.Amount)</td>
                                        <td>@string.Format("{0:MM-dd-yyyy}", item.DateTime)</td>
                                        <td class="rece-type">@item.PaymentType</td>
                                        <td>@item.Ch_Pay_Draft_No</td>
                                        <td>
                                            @if (item.Verified == true)
                                            {
                                                <i class="ti-check"></i>
                                            }
                                            else
                                            {
                                                <i class="ti-close"></i>
                                            }
                                        </td>
                                        <td>
                                            <ul style="list-style:none;margin-left:0px;">
                                                <li class="dropdown">
                                                    <a href="" class="dropdown-toggle no-after peers " data-toggle="dropdown">
                                                        <i class="ti-more-alt  c-grey-900" style="transform:rotate(90deg);"></i>
                                                    </a>
                                                    <ul class="dropdown-menu" style="padding:10px;width:auto !important">
                                                        <li><a id="@item.Id" class="pointer get-rec-data" data-toggle="modal" data-target="#Modal"><span>Update</span></a></li>
                                                        <hr />
                                                        <li><a id="@item.Id" class="del-rec-com pointer"><span>Delete</span></a></li>
                                                        <hr />
                                                        <li><a id="" class="rece-refund-pop pointer" data-toggle="modal" data-target="#Modal"><span>Refund</span></a></li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </td>
                                    </tr>
                                    srcountd++;
                                }
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
        <div class="form-row">
            <div class="col-md-8" id="plot-rep">
                @{Html.RenderAction("Ledger", "Commercial", new { Commercial_Id = Model.commercialData.Id });}
            </div>
            <div class="col-md-4">
            </div>
        </div>
    </div>
}
else
{
    <div class="bgc-white p-20 bd">
        <h5 class="c-grey-900">No Record Found</h5>
    </div>
}
<input type="file" class="own-img-fl-slcxn-ghjfsd" style="display:none;" data-ownid="0" data-forid="0" />
<script>
    $(function () {
        Initcity(1);
    });

    function readURLs(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                $('#own_img__new').attr('src', e.target.result);
            }

            reader.readAsDataURL(input.files[0]);
        }
    };

    $(document).ready(function () {
        $('.hvr-opt-disp').unbind().hover(function () {
            if ($(this).find('span').is(':visible')) {
                $(this).find('span').css({
                    display: 'none'
                }).removeClass('animate__animated animate__fadeInDown');
            }
            else {
                $(this).find('span').css({
                    display: 'flex'
                }).addClass('animate__animated animate__fadeInDown');
            }
        });

        $('.own-img-upld-fdjsgha').unbind().click(function () {
            let imgCnt = $(this).closest('.hvr-opt-disp').find('img').attr('data-hint');
            let owning = $(this).closest('.hvr-opt-disp').find('img').attr('data-owner');
            $('.own-img-fl-slcxn-ghjfsd').attr('data-forid', imgCnt);
            $('.own-img-fl-slcxn-ghjfsd').attr('data-ownid', owning);
            $('.own-img-fl-slcxn-ghjfsd').click();
        });

        $('.own-img-fl-slcxn-ghjfsd').unbind().change(function () {
            //
            let input = $('.own-img-fl-slcxn-ghjfsd');
            let imgId = $(this).attr('data-forid');
            let ownId = $(this).attr('data-ownid');
            if (input.prop('files') && input.prop('files')[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    $('.owner-img-' + imgId).attr('src', e.target.result);
                    ShowFullScreenLoader();
                    $.ajax({
                        type: "POST",
                        url: '/Commercial/UpdateCustomerImg/',
                        data: { id: ownId, img: e.target.result, cnt: imgId },
                        success: function (data) {
                            if (data == true) {
                                alert('Image has been updated successfully');
                            }
                            else {
                                alert('Failed to update image.');
                            }
                            HideFullScreenLoader();
                        }
                        ,
                        error: function () {
                            HideFullScreenLoader();
                        }
                    });
                }

                reader.readAsDataURL(input.prop('files')[0]);
            }
        });

        //sending the data of the owner to the server

        $('.sav-info-com').unbind().click(function () {
            if (!confirm('Are you sure you want to update this customer\'s details?')) {
                return;
            }

            //yahan pe server ko hit maarni hai
            var that = $(this);
            let prnt = $(this).closest(".own-det");
            var id = $(this).attr("data-ownid");
            var buildingId = $("#com_rom_tag").val();
            var grp = $(this).closest(".own-det").find(".groupId").val();
            var plotowndata = {
                Id: id,
                Name: $(prnt).find("#Name").val(),
                Father_Husband: $(prnt).find("#Father_Husband").val(),
                Postal_Address: $(prnt).find("#Postal_Address").val(),
                Residential_Address: $(prnt).find("#Residential_Address").val(),
                Phone_Office: (prnt).find("#Phone_Office").val(),
                Residential: $(prnt).find("#Residential").val(),
                Mobile_1: $(prnt).find("#Mobile_1").val(),
                Mobile_2: $(prnt).find("#Mobile_2").val(),
                Email: $(prnt).find("#Email").val(),
                Occupation: $(prnt).find("#Occupation").val(),
                Nationality: $(prnt).find("#Nationality").val(),
                Date_Of_Birth: $(prnt).find("#Date_Of_Birth").val(),
                CNIC_NICOP: $(prnt).find("#CNIC_NICOP").val(),
                Nominee_Name: $(prnt).find("#Nominee_Name").val(),
                Nominee_Relation: $(prnt).find("#Nominee_Relation").val(),
                Nominee_Address: $(prnt).find("#Nominee_Address").val(),
                Nominee_CNIC_NICOP: $(prnt).find("#Nominee_CNIC_NICOP").val(),
                DateTime: $(prnt).find("#Ownership_DateTime").val(),
                Ownership_Status: $(prnt).find("#Ownership_Status option:selected").val(),
                Plot_Id: buildingId,
                GroupTag: grp
            }
            if (plotowndata.Name == null || plotowndata.Name.trim() == "") {
                alert("Please Enter Name");
                return false;
            }
            else if (plotowndata.CNIC_NICOP == null || plotowndata.CNIC_NICOP.trim() == "") {
                alert("Please CNIC");
                return false;
            }
            else if (plotowndata.DateTime == null || plotowndata.DateTime.trim() == "") {
                alert("Ownership Date");
                return false;
            }

            ShowFullScreenLoader();
            $.ajax({
                type: "POST",
                contentType: "application/json; charset=utf-8",
                url: '/Commercial/UpdateCommercialOwnerResult/',
                data: JSON.stringify(plotowndata),
                success: function (data) {
                    if (data) {
                        alert("Owner data has been updated");
                        window.location.reload(true);
                    }
                    else {
                        alert('Failed to save owner details.')
                    }

                    HideFullScreenLoader();
                },
                error: function (data) {
                    HideFullScreenLoader();
                }
            });
        });

        $(document).on("click", ".com-upd-info", function () {

            let prnt = $(this).closest('.own-det');
            $(prnt).find('input').prop('readonly', false);
            $(prnt).find('.sav-info-com').show();
            $(this).hide();
            //var id = $(this).closest(".own-det").attr("id");
            //$("#" + id + " :input").prop("readonly", false);
            //$("#" + id + " .sav-info-com").show();
            //$("#" + id + " .own-img").show();
        });
    });

</script>
